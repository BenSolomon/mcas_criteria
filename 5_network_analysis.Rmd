---
title: "Diagnosis network analysis"
output: html_notebook
---

# Setup

```{r}
library(here)
library(tidyverse)
library(igraph)
library(tidygraph)
library(ggraph)
```

```{r}
source("util_functions.R")

parse_diagnoses_mcas <- function(sim_results, consensus){
  sim_results <- do.call(rbind, sim_results[consensus, ])
  map(sim_results$diagnoses, process_diagnoses) %>% 
    enframe(name = "iteration", value = "diagnosis") %>% 
    unnest(diagnosis) %>% 
    mutate(consensus = consensus)
}

parse_mcas_rds <- function(sim_results){
  bind_rows(
    parse_diagnoses_mcas(sim_results, "consensus1"),
    parse_diagnoses_mcas(sim_results, "consensus2")
  )
}

parse_diagnoses_alt <- function(sim_results){
  tibble(criteria = rownames(sim_results)) %>% 
    mutate(data = map(criteria, function(c){
      do.call(rbind, sim_results[c,]) %>% 
        mutate(iteration = 1:n()) %>% 
        mutate(diagnosis = map(diagnoses, process_diagnoses)) %>% 
        unnest(diagnosis) %>% 
        select(iteration, diagnosis)
      })) %>% 
    unnest(data)
}
```

# Prepare data

```{r read_mcas}
### Read MCAS diagnoses
df_mcas <- tibble(file = list.files("data/chatgpt_output/name_n20000/", full.names = T)) %>% 
  filter(grepl("RDS$", file)) %>% 
  mutate(data = map(file, readRDS)) %>% 
  mutate(data = map(data, parse_mcas_rds)) %>% 
  unnest(data)
df_mcas
```

```{r create_mcas_codiagnoses}
### Identify co-diagnoses in MCAS data
df_codiag_mcas <- df_mcas %>% 
  group_by(file, consensus, iteration) %>% 
  nest() %>% 
  mutate(len = map_dbl(data, nrow)) %>% 
  filter(len > 2) %>% 
  mutate(data = map(data, function(x) {
    try(as.data.frame(t(combn(sort(x$diagnosis), 2))))
  })) %>% 
  unnest(data) %>% 
  ungroup() %>% 
  count(consensus, V1, V2, sort = T)

df_codiag_mcas
```

```{r read_sle}
# Read in ChatGPT output data for additional conditions and parse
df_sle <- tibble(file = list.files(here("data/chatgpt_output/other_conditions"), full.names = T))%>% 
  mutate(data = map(file, readRDS)) %>% 
  mutate(data = map(data, parse_diagnoses_alt)) %>% 
  unnest(data) %>% 
  filter(grepl("sle", criteria))

df_sle
```

```{r create_sle_codiagnoses}
### Identify co-diagnoses in SLE data
df_codiag_sle <- df_sle %>% 
  group_by(file, criteria, iteration) %>% 
  nest() %>% 
  mutate(len = map_dbl(data, nrow)) %>% 
  filter(len > 2) %>% 
  mutate(data = map(data, function(x) {
    try(as.data.frame(t(combn(sort(x$diagnosis), 2))))
  })) %>% 
  unnest(data) %>% 
  ungroup() %>% 
  count(criteria, V1, V2, sort = T)

df_codiag_sle
```

```{r compile_codiagnoses}
### Combine MCAS and SLE co-diagnoses
df_codiag <- rbind(
  df_codiag_mcas %>% rename(criteria = consensus),
  df_codiag_sle
)

df_codiag
```
# Build network graph

```{r}
top_n <-  100
top_f <- 0.15

g <- df_codiag %>% 
  filter(V1 != V2) %>% 
  rowwise() %>% 
  mutate(from = min(V1, V2), to = max(V1, V2)) %>% 
  ungroup() %>% 
  group_by(criteria, from, to) %>% 
  summarise(n = sum(n)) %>% 
  group_by(criteria) %>%
  arrange(desc(n), .by_group = T) %>% 
  mutate(rank = 1:n())  %>% 
  mutate(freq = n/sum(n)) %>%
  mutate(cum_freq = cumsum(freq)) %>% 
  select(from, to, criteria, rank, freq, cum_freq) %>% 
  filter(rank <= top_n) %>%
  # filter(cum_freq <= top_f) %>% 
  as_tbl_graph()

g
```

```{r}
set.seed(1)
ggraph(g, layout = 'fr') + 
    geom_edge_link(alpha = 0.5) +
    geom_node_point(size = 0.5) +
  facet_wrap(~criteria) +
  theme_void() +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1))
```
### Network measures

```{r}
data.frame(criteria = g %>% activate(edges) %>% pull(criteria) %>% unique()) %>% 
  mutate(sub_graphs = map(criteria, function(c){
    g %>% 
      activate(edges) %>%
      filter(criteria == c) %>%
      mean_distance()
  })) %>% 
  unnest(sub_graphs) 
```


# Subgraph similarity

### Based on count of 
```{r}
# input_data <- "freq"
input_data <- "rank"

pivot_function <- function(x, data_type, top_n = NA){
  if(data_type == "freq") {return(x)}
  if(data_type == "rank") {
    return(top_n - x + 1)
    }
}

df_connection <- g %>% 
  activate(edges) %>% 
  data.frame() %>% 
  unite(connection, from, to, sep = "_") %>% 
  select(criteria, c(input_data), connection) %>% 
  pivot_wider(names_from = "connection", values_from = input_data, values_fn = function(x) pivot_function(x, data_type = input_data, top_n = top_n), values_fill = 0) %>% 
  column_to_rownames("criteria")
df_connection
```

```{r}
ComplexHeatmap::Heatmap(df_connection, col = viridis::viridis(100))
```

```{r, fig.width=5, fig.height=4}
ComplexHeatmap::Heatmap(cor(t(df_connection), method = "pearson"))
ComplexHeatmap::Heatmap(cor(t(df_connection), method = "spearman"))
```

```{r, fig.width=5, fig.height=4}
# Removing scale of connections and just using presence or absence
ComplexHeatmap::Heatmap(cor(t(df_connection %>% mutate_all(~ifelse(.>0,1,0))), method = "pearson"))
ComplexHeatmap::Heatmap(cor(t(df_connection %>% mutate_all(~ifelse(.>0,1,0))), method = "spearman"))
```

### Based on centrality

```{r}
df_centrality <- data.frame(criteria = g %>% activate(edges) %>% pull(criteria) %>% unique()) %>% 
  mutate(sub_graphs = map(criteria, function(c){
    g %>% 
      activate(edges) %>% 
      filter(criteria == c) %>% 
      activate(nodes) %>% 
      mutate(ce = centrality_eigen()) %>% 
      data.frame()
  })) %>% 
  unnest(sub_graphs) %>% 
  pivot_wider(names_from = "name", values_from = "ce", values_fill = 0) %>% 
  column_to_rownames("criteria")
df_centrality
```

```{r, fig.width=16, fig.height=4}
ComplexHeatmap::Heatmap(df_centrality, col = viridis::viridis(100))
```

```{r, fig.width=5, fig.height=4}
ComplexHeatmap::Heatmap(cor(t(df_centrality), method = "pearson"))
ComplexHeatmap::Heatmap(cor(t(df_centrality), method = "spearman"))
```

```{r}
cos_sim <- function(x){
  Matrix <- as.matrix(x)
  sim <- Matrix / sqrt(rowSums(Matrix * Matrix))
  sim <- sim %*% t(sim)
  sim
}

```

```{r, fig.width=5, fig.height=4}
ComplexHeatmap::Heatmap(lsa::cosine(t(as.matrix(df_centrality))), col = viridis::viridis(100))
```

# Find mast cell activation in network

```{r}
g <- df_codiag %>% 
  filter(V1 != V2) %>% 
  rowwise() %>% 
  mutate(from = min(V1, V2), to = max(V1, V2)) %>% 
  ungroup() %>% 
  as_tbl_graph()
```

```{r}
x <- g %>% activate(nodes) %>% as.data.frame()
```

```{r}
df_centrality <- data.frame(criteria = g %>% activate(edges) %>% pull(criteria) %>% unique()) %>% 
  mutate(sub_graphs = map(criteria, function(c){
    g %>% 
      activate(edges) %>% 
      filter(criteria == c) %>% 
      activate(nodes) %>% 
      mutate(ce = centrality_eigen()) %>% 
      data.frame()
  })) %>% 
  unnest(sub_graphs) %>% 
  pivot_wider(names_from = "name", values_from = "ce", values_fill = 0) %>% 
  column_to_rownames("criteria")
df_centrality
```

```{r}
mastocytosis_patterns <- c("mastocytosis", "systemic mastocytosis", "aerial mastocytosis", "cutaneous mastocytosis")
mcas_patters <- c("mast cell activation syndrome", "mast cell activation disorder")

df_codiag %>% 
  filter(V1 != V2) %>% 
  mutate_at(vars(c(V1, V2)), ~ifelse(. %in% mastocytosis_patterns, "mastocytosis", .)) %>% 
  mutate_at(vars(c(V1, V2)), ~ifelse(. %in% mcas_patters, "mast cell activation syndrome", .)) %>% 
  rowwise() %>% 
  mutate(from = min(V1, V2), to = max(V1, V2)) %>% 
  ungroup() %>% 
  group_by(criteria, from, to) %>% 
  summarise(n = sum(n)) %>% 
  group_by(criteria) %>% 
  nest() %>% 
  mutate(data = map(data, function(d){
    as_tbl_graph(d, directed = F) %>% 
      activate(nodes) %>% 
      mutate(ce = centrality_eigen()) %>% 
      mutate(cd = centrality_degree()) %>% 
      data.frame()
  })) %>% 
  unnest(data) %>% 
  filter(name %in% c("mastocytosis", "mast cell activation syndrome"))
```

```{r}
g <- df_codiag %>% 
  filter(V1 != V2) %>% 
  mutate_at(vars(c(V1, V2)), ~ifelse(. %in% mastocytosis_patterns, "mastocytosis", .)) %>% 
  mutate_at(vars(c(V1, V2)), ~ifelse(. %in% mcas_patters, "mast cell activation syndrome", .)) %>% 
  rowwise() %>% 
  mutate(from = min(V1, V2), to = max(V1, V2)) %>% 
  ungroup() %>% 
  group_by(criteria, from, to) %>% 
  summarise(n = sum(n)) %>% 
  group_by(criteria) %>% 
  ungroup() %>% 
  as_tbl_graph()
```
```{r}
df_ce <- data.frame(criteria = g %>% activate(edges) %>% pull(criteria) %>% unique()) %>% 
  mutate(sub_graphs = map(criteria, function(c){
    g %>% 
      activate(edges) %>% 
      filter(criteria == c) %>% 
      activate(nodes) %>% 
      mutate(c_degree = centrality_degree()) %>% 
      mutate(c_eigen = centrality_eigen()) %>% 
      mutate(c_between = centrality_betweenness(normalized = T)) %>% 
      mutate(c_close = centrality_closeness(normalized = T)) %>% 
      data.frame()
  })) %>% 
  unnest(sub_graphs) 
```

```{r}
df_ce %>% 
  {. %>% filter(grepl("mast cell activation", name)) %>% return();.} %>%  
  filter(grepl("mastocytosis", name)) 
```

# Comparison of metrics with full vs. filtered graph

### Full graph

```{r}
g <- df_codiag %>% 
  filter(V1 != V2) %>% 
  rowwise() %>% 
  mutate(from = min(V1, V2), to = max(V1, V2)) %>% 
  ungroup() %>% 
  as_tbl_graph()
```

```{r}
Compactness <- function(g) {
        gra.geo <- distances(g) ## get geodesics
        gra.rdist <- 1/gra.geo  ## get reciprocal of geodesics
        diag(gra.rdist) <- NA   ## assign NA to diagonal
        gra.rdist[gra.rdist == Inf] <- 0 ## replace infinity with 0
          # Compactness = mean of reciprocal distances
        comp.igph <- mean(gra.rdist, na.rm=TRUE) 
        return(comp.igph)
        }
```

```{r}
data.frame(criteria = g %>% activate(edges) %>% pull(criteria) %>% unique()) %>% 
  mutate(sub_graphs = map(criteria, function(c){
    g %>% 
      activate(edges) %>%
      filter(criteria == c) %>%
      Compactness()
      # edge_density()
      # mean_distance()
  })) %>% 
  unnest(sub_graphs) 
```
https://rpubs.com/pjmurphy/308024

```{r}
df_centrality <- data.frame(criteria = g %>% activate(edges) %>% pull(criteria) %>% unique()) %>% 
  mutate(sub_graphs = map(criteria, function(c){
    g %>% 
      activate(edges) %>% 
      filter(criteria == c) %>% 
      activate(nodes) %>% 
      mutate(ce = centrality_eigen()) %>% 
      data.frame()
  })) %>% 
  unnest(sub_graphs) %>% 
  pivot_wider(names_from = "name", values_from = "ce", values_fill = 0) %>% 
  column_to_rownames("criteria")
df_centrality
```
```{r, fig.width=5, fig.height=4}
ComplexHeatmap::Heatmap(lsa::cosine(t(as.matrix(df_centrality))), col = viridis::viridis(100))
```



