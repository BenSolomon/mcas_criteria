---
title: "Diagnosis distribution analysis"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

```{r, message = F}
library(here)
library(cowplot)
source(here("utils/data_processing.R"))
source(here("utils/figures.R"))
```

# Import data
```{r}
df_gpt3 <- process_json(here("data/chatgpt_json_output/gpt-3.5-turbo-1106/"))
df_gpt4 <- process_json(here("data/chatgpt_json_output/gpt-4-turbo-preview/"))
```
# Rank abundance
```{r}
rank_abundance_plot(df_gpt3)+ggtitle("GPT3")
rank_abundance_plot(df_gpt4)+ggtitle("GPT4")
```

# Top diagnoses
```{r, fig.width = 12, fig.height = 8}
top_diagnosis_plot(df_gpt3, n_diag = 25)+ggtitle("GPT3")
top_diagnosis_plot(df_gpt4, n_diag = 25)+ggtitle("GPT4")
```

# Cumulative top frequency
```{r, fig.width=3, fig.height=3.5}
cumulative_frequency_plot(df_gpt3)
cumulative_frequency_plot(df_gpt4)
```

# Diagnosis rank list
```{r}
diagnosis_rank_table(df_gpt3, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60))
diagnosis_rank_table(df_gpt4, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
```

```{r}
diagnosis_rank_table(df_gpt4, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) %>% 
  select(contains(c("diagnosis","mcas"))) %>% 
  head(6) %>% 
  mutate(diagnosis = str_to_sentence(diagnosis)) %>% 
  rename(Diagnosis = diagnosis, `MCAS consortium` = mcas_consortium, `MCAS alternative` = mcas_alternative) %>% 
  flextable() %>% 
  width(width = 2) %>% 
  align(j = 2:3, align = "center", part = "all")
  
```




# Diversity
```{r, fig.width=4, fig.height=3.5}
set.seed(1234)
df_diversity_ci <- df_gpt4 %>% 
  count(criteria, diagnosis, sort = T) %>% 
  group_by(criteria) %>% 
  nest() %>% 
  mutate(boot = map(data, function(x){
    x <- deframe(x)
    x <- entropart::EntropyCI(entropart::Shannon, 
                              Simulations=500, 
                              Ns = x, q=1, 
                              Correction = "None")
    x
  })) %>% 
  mutate(shannon = map_dbl(data, 
                           ~log(entropart::Diversity(deframe(.), q=1, Correction="None")))) %>% # Calculate shannon with entropart
  mutate(boot = map(boot, ~quantile(., c(0.025,0.5,0.975)))) %>% 
  unnest_wider(boot)

df_diversity_ci %>% 
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = shannon))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Shannon diversity") 
```

### Permutation testing


```{r}
# Toy example of permutation pipeline. Only using first 10 GPT iterations (out of 10,000)
difference_permutation_test(df_gpt4, metric = "diversity", permutations = 10, gpt_iterations = 10)
```
```{r, eval = F}
# Run outside of notebook
# Includes all 10,000 GPT iterations and 1000 bootstrap permutations 
source(here("scripts/permute_null_diversity_difference.R"))
```

```{r}
diversity_permutation_results <- readRDS(here("data/diversity_permutation_test.RDS")) 
diversity_permutation_results
permutation_test_plot(diversity_permutation_results)
```


# Similarity

### Jaccard/Bray curtis
```{r, fig.width=4.25, fig.height=3.5}
diagnosis_similarity_heatmap(df_gpt3, method = "bray")
diagnosis_similarity_heatmap(df_gpt4, method = "bray")
diagnosis_similarity_heatmap(df_gpt3)
diagnosis_similarity_heatmap(df_gpt4)
```
- Bray-Curtis similarity measures the similarity of a given diagnostic criteriaâ€™s set of alternative diagnoses along with their frequencies.
- This demonstrates that SLE criteria results in a very similar set and frequency of diagnoses, while the diagnoses associated with two MCAS criteria are as different from each other as they are from those generated by the criteria of other conditions.

### PCA

```{r, fig.width=4.25, fig.height=3.5}
diagnosis_pca_plot(df_gpt3) + ggtitle("GPT3")
diagnosis_pca_plot(df_gpt4) + ggtitle("GPT4")
```
# Precision

```{r}
readRDS(here("data/precision_permutation_test.RDS"))
readRDS(here("data/precision_permutation_test_p100_i5000.RDS"))
readRDS(here("../data/precision_permutation_test"))
```

  pair                             data     null_ecdf null_mean   `2.5%`   `50%` `97.5%` difference p_value p_value_adj
   <chr>                            <list>   <list>        <dbl>    <dbl>   <dbl>   <dbl>      <dbl>   <dbl>       <dbl>
 1 aha_kawasaki.eular_acr_sle       <tibble> <ecdf>      0.00982 0.000584 0.00805  0.0281    0.00891 0.461       0.494  
 2 aha_kawasaki.mcas_alternative    <tibble> <ecdf>      0.120   0.102    0.120    0.141     0.214   0           0      
 3 aha_kawasaki.mcas_consortium     <tibble> <ecdf>      0.0485  0.0271   0.0484   0.0735    0.0955  0           0      
 4 aha_kawasaki.migraine            <tibble> <ecdf>      0.0583  0.0338   0.0585   0.0833    0.0945  0.00100     0.00115
 5 aha_kawasaki.slicc_sle           <tibble> <ecdf>      0.0378  0.0118   0.0381   0.0624    0.0994  0           0      
 6 eular_acr_sle.mcas_alternative   <tibble> <ecdf>      0.120   0.102    0.120    0.140     0.205   0           0      
 7 eular_acr_sle.mcas_consortium    <tibble> <ecdf>      0.0485  0.0254   0.0488   0.0702    0.0865  0           0      
 8 eular_acr_sle.migraine           <tibble> <ecdf>      0.0584  0.0337   0.0579   0.0832    0.103   0           0      
 9 eular_acr_sle.slicc_sle          <tibble> <ecdf>      0.0378  0.0119   0.0381   0.0632    0.108   0           0      
10 mcas_alternative.mcas_consortium <tibble> <ecdf>      0.0719  0.0549   0.0720   0.0889    0.119   0           0      
11 mcas_alternative.migraine        <tibble> <ecdf>      0.179   0.156    0.179    0.198     0.309   0           0      
12 mcas_alternative.slicc_sle       <tibble> <ecdf>      0.158   0.137    0.158    0.180     0.314   0           0      
13 mcas_consortium.migraine         <tibble> <ecdf>      0.107   0.0823   0.107    0.130     0.190   0           0      
14 mcas_consortium.slicc_sle        <tibble> <ecdf>      0.0863  0.0613   0.0863   0.109     0.195   0           0      
15 migraine.slicc_sle               <tibble> <ecdf>      0.0212  0.00127  0.0206   0.0490    0.00493 0.892       0.892 


```{r}
readRDS(here("data/precision_permutation_test.RDS")) %>% permutation_test_plot()
readRDS(here("data/precision_permutation_test_p100_i5000.RDS")) %>% permutation_test_plot()
```
```{r}
x <- readRDS(here("data/precision_permutation_test.RDS")) 
```

```{r}
df <- read_csv( here("data/diagnosis_precision.csv.gz"))
```


```{r}
df2 <- df %>% 
  count(criteria, distance)
```

```{r}
df %>% slice_sample(n=100) %>% 
  filter
```

```{r}
set.seed(1234)
df_precision <- df_gpt4 %>%  
  filter(i %in% sample(1:10000, 100)) %>% 
  group_by(criteria) %>% 
  nest() %>% 
  mutate(data = map(data, function(df){
    diagnosis_table <- table(df$i, df$diagnosis)
    dist_mtx <- parallelDist::parDist(diagnosis_table, method = "bray", threads = 80)
    # dist_mtx <- vegan::vegdist(diagnosis_table, method = "bray")
    broom::tidy(dist_mtx) %>% 
    select(distance)
  })) %>% 
  unnest(data)
df_precision
```
```{r, fig.height=3.5, fig.width=4}
df_precision %>% 
  ungroup() %>%
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = 1-distance))+
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4)+
  stat_summary(fun = mean, geom = "point")+
  theme_bw()+
  # ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(x = "", y = "Precision\n(Bray-Curtis Similarity)")
```
```{r}
df_precision %>% 
  ungroup() %>%
  format_criteria() %>% 
  summarise(mean_cl_normal(1-distance), .by = criteria)
```
```{r}
df <- read_csv(here("data/archive/compiled_all_chatgpt_diagnoses.csv"))
df
```
```{r}
df_precision <- df_gpt4 %>%  
  head(117354) %>% 
  # unite("sample", file, iteration, sep = "__") %>% 
  group_by(criteria) %>% 
  nest() %>% 
  mutate(data = map(data, function(df){
    df %>% 
    mutate(count = 1) %>% 
    pivot_wider(names_from = "diagnosis", values_from = "count", values_fill = 0, values_fn = sum) %>% 
    column_to_rownames("i") %>% 
    vegan::vegdist(method = "bray") %>%
    # vegan::vegdist(method = "bray") %>% 
    broom::tidy()
  })) %>% 
  unnest(data)
df_precision
```

```{r, fig.height=3.5, fig.width=4}
df_precision %>% 
  ungroup() %>%
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = 1-distance))+
  # stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.4)+
  # stat_summary(fun = mean, geom = "point")+
  geom_boxplot(outlier.shape = NA)+
  theme_bw()+
  # ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(x = "", y = "Precision\n(Bray-Curtis Similarity)")
```



```{r}
calculate_precision(df_gpt4, iterations = 1000) %>% 
  mutate(similarity = 1-distance) %>% 
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = similarity)) +
  geom_boxplot(outlier.shape = NA)+
  stat_summary(fun = mean, geom = "point")+
  theme_bw()+
  theme(axis.text.x = element_text(angle= 45, hjust = 1))
```

  pair                             data     null_ecdf null_mean   `2.5%`   `50%` `97.5%` difference p_value p_value_adj
   <chr>                            <list>   <list>        <dbl>    <dbl>   <dbl>   <dbl>      <dbl>   <dbl>       <dbl>
 1 aha_kawasaki.eular_acr_sle       <tibble> <ecdf>      0.00982 0.000584 0.00805  0.0281    0.00891 0.461       0.494  
 2 aha_kawasaki.mcas_alternative    <tibble> <ecdf>      0.120   0.102    0.120    0.141     0.214   0           0      
 3 aha_kawasaki.mcas_consortium     <tibble> <ecdf>      0.0485  0.0271   0.0484   0.0735    0.0955  0           0      
 4 aha_kawasaki.migraine            <tibble> <ecdf>      0.0583  0.0338   0.0585   0.0833    0.0945  0.00100     0.00115
 5 aha_kawasaki.slicc_sle           <tibble> <ecdf>      0.0378  0.0118   0.0381   0.0624    0.0994  0           0      
 6 eular_acr_sle.mcas_alternative   <tibble> <ecdf>      0.120   0.102    0.120    0.140     0.205   0           0      
 7 eular_acr_sle.mcas_consortium    <tibble> <ecdf>      0.0485  0.0254   0.0488   0.0702    0.0865  0           0      
 8 eular_acr_sle.migraine           <tibble> <ecdf>      0.0584  0.0337   0.0579   0.0832    0.103   0           0      
 9 eular_acr_sle.slicc_sle          <tibble> <ecdf>      0.0378  0.0119   0.0381   0.0632    0.108   0           0      
10 mcas_alternative.mcas_consortium <tibble> <ecdf>      0.0719  0.0549   0.0720   0.0889    0.119   0           0      
11 mcas_alternative.migraine        <tibble> <ecdf>      0.179   0.156    0.179    0.198     0.309   0           0      
12 mcas_alternative.slicc_sle       <tibble> <ecdf>      0.158   0.137    0.158    0.180     0.314   0           0      
13 mcas_consortium.migraine         <tibble> <ecdf>      0.107   0.0823   0.107    0.130     0.190   0           0      
14 mcas_consortium.slicc_sle        <tibble> <ecdf>      0.0863  0.0613   0.0863   0.109     0.195   0           0      
15 migraine.slicc_sle               <tibble> <ecdf>      0.0212  0.00127  0.0206   0.0490    0.00493 0.892       0.892 



# Final figures

### 2_Top_diagnoses
```{r, fig.width=7.4, fig.height=6.5}
custom_labeler <- function(x) {
    x %>%
        str_replace("___.+$", "") %>%
        str_wrap(width = 33, )
}

plt_top <- top_diagnosis_plot(df_gpt4, n_diag = 25) + 
  theme(axis.text = element_text(size = 5, lineheight = 0.7), 
        strip.text = element_text(size = 7),
        axis.title = element_text(size = 9)) + 
  tidytext::scale_x_reordered(labels = custom_labeler)
plt_top
ggsave(here("figures/2_Top_25_diagnoses.pdf"), plot=plt_top, width = 7.4, height = 6.8)
```
### 3A_Rank_abundance
```{r, fig.width=3.5, fig.height=2.5}
plt_rank <- rank_abundance_plot(df_gpt4) +theme(legend.position = c(0.7,0.7))
plt_rank
# ggsave(here("figures/3A_Rank_abundance.pdf"), plot=plt_rank, width = 3.5, height = 2.5)
```

### 3B_Cumulative_frequency

```{r, fig.width=2.5, fig.height=2.5}
plt_cumulative <- cumulative_frequency_plot(df_gpt4) +
  labs(y = "Combined frequency\nof top 25 diagnoses")
# ggsave(here("figures/3B_Top_cumulative.pdf"), plot=plt_cumulative, width = 2.5, height = 2.5)
```



### 3C_Diversity
```{r, fig.width=3, fig.height=3}
plt_div <- df_diversity_ci %>% 
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = shannon))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Shannon diversity") 
plt_div
# ggsave(here("figures/3C_Diversity.pdf"), plot=plt_div, width = 3, height = 3)
```

```{r, message = F}
# pdf(file = here("test.pdf"), width = 5, height = 5)
diagnosis_rank_table(df_gpt4, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) %>% 
  select(contains(c("diagnosis","mcas"))) %>% 
  head(6) %>% 
  mutate(diagnosis = str_to_sentence(diagnosis)) %>% 
  rename(Diagnosis = diagnosis, `MCAS consortium` = mcas_consortium, `MCAS alternative` = mcas_alternative) %>% 
  flextable() %>% 
  width(width = 2) %>% 
  align(j = 2:3, align = "center", part = "all") 
# dev.off()
```

### Compiled 

```{r, fig.width=7, fig.height=6}
plot_grid(
  plot_grid(
    rank_abundance_plot(df_gpt4) +theme(legend.position = c(0.7,0.7)),
    cumulative_frequency_plot(df_gpt4),
    nrow = 1, 
    rel_widths = c(3,2)
  ),
  plot_grid(
    df_diversity_ci %>% 
      format_criteria() %>% 
      ggplot(aes(x = criteria, y = shannon))+
      geom_point(size = 1)+
      geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
      theme_bw() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(x = "", y = "Shannon diversity"),
    df_diversity_ci %>% 
      format_criteria() %>% 
      ggplot(aes(x = criteria, y = shannon))+
      geom_point(size = 1)+
      geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
      theme_bw() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(x = "", y = "Shannon diversity"),
    nrow = 1
  ),
  nrow = 2
)
```


