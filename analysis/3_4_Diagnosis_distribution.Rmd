---
title: "Diagnosis distribution analysis"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

```{r, message = F}
library(here)
library(cowplot)
source(here("utils/data_processing.R"))
source(here("utils/figures.R"))
```

# Import data
```{r, message=F}
# Original outputs
df_gpt3.5 <- read_csv(here("data/processed_diagnoses/diagnoses_gpt3.csv.gz"))
df_gpt4.0 <- read_csv(here("data/processed_diagnoses/diagnoses_gpt4.csv.gz"))
df_claude3_haiku_t1.0 <- read_csv(here("data/processed_diagnoses/diagnoses_claude3_haiku_t1.0.csv.gz"))
df_claude3_haiku_t0.1 <- read_csv(here("data/processed_diagnoses/diagnoses_claude3_haiku_t0.1.csv.gz"))
df_claude3_opus_t1.0 <- read_csv(here("data/processed_diagnoses/diagnoses_claude3_opus_t1.0.csv.gz"))
df_gemini1.0_pro_t1.0 <- read_csv(here("data/processed_diagnoses/diagnoses_gemini1.0_pro_t1.0.csv.gz"))
df_gemini1.5_flash_t1.0 <- read_csv(here("data/processed_diagnoses/diagnoses_gemini1.0_pro_t1.0.csv.gz"))
```

```{r, message = F}
# ICD mapped outputs
#TODO Find source of NAs 
df_gpt3.5_icd <- read_csv(here("data/processed_diagnoses/diagnoses_gpt3.5_icd.csv.gz")) %>% drop_na()
df_gpt4.0_icd <- read_csv(here("data/processed_diagnoses/diagnoses_gpt4_icd.csv.gz")) %>% drop_na()
df_claude3_haiku_t1.0_icd <- read_csv(here("data/processed_diagnoses/diagnoses_claude3_haiku_t1.0_icd.csv.gz")) %>% drop_na()
df_claude3_opus_t1.0_icd <- read_csv(here("data/processed_diagnoses/diagnoses_claude3_opus_t1.0_icd.csv.gz")) %>% drop_na()
df_gemini1.0_pro_t1.0_icd <- read_csv(here("data/processed_diagnoses/diagnoses_gemini1.0_pro_t1.0_icd.csv.gz")) %>% drop_na()
```


# Rank abundance
```{r}
rank_abundance_plot(df_gpt3.5)+ggtitle("ChatGPT 3.5")
rank_abundance_plot(df_gpt4.0)+ggtitle("ChatGPT 4.0")
rank_abundance_plot(df_claude3_haiku_t1.0)+ggtitle("Claude3 Haiku t1.0")
rank_abundance_plot(df_claude3_haiku_t0.1)+ggtitle("Claude3 Haiku t0.1")
rank_abundance_plot(df_claude3_opus_t1.0)+ggtitle("Claude3 Opus")
rank_abundance_plot(df_gemini1.0_pro_t1.0)+ggtitle("Gemini 1.0 Pro")
rank_abundance_plot(df_gemini1.5_flash_t1.0)+ggtitle("Gemini 1.5 Flash")
```

```{r}
rank_abundance_plot(df_gpt3.5_icd)+ggtitle("ChatGPT 3.5 ICD")
rank_abundance_plot(df_gpt4.0_icd)+ggtitle("ChatGPT 4.0 ICD")
rank_abundance_plot(df_claude3_haiku_t1.0_icd)+ggtitle("Claude3 Haiku ICD")
rank_abundance_plot(df_claude3_opus_t1.0_icd)+ggtitle("Claude3 Opus ICD")
rank_abundance_plot(df_gemini1.0_pro_t1.0_icd)+ggtitle("Gemini 1.0 Pro ICD")
```


```{r}
bind_rows(
  rank_abundance_plot(df_gpt3.5)$data,
  rank_abundance_plot(df_gpt4.0)$data,
  # rank_abundance_plot(df_gpt4_icd)$data,
  rank_abundance_plot(df_claude3_haiku_t1.0)$data,
  rank_abundance_plot(df_claude3_opus_t1.0)$data,
  rank_abundance_plot(df_gemini1.0_pro_t1.0)$data,
  rank_abundance_plot(df_gemini1.5_flash_t1.0)$data
) %>% 
  ggplot(aes(x = rank, y = freq, color = criteria))+
  # geom_point(size = 0.1)+
  stat_summary(fun.data = mean_se, geom = "ribbon", fill = "grey75", color = "grey75", mapping = aes(group = criteria)) +
  stat_summary(fun.y = mean, geom = "path", size = 1) +
  scale_color_manual(values = brewer.pal(7, "Set1")[-6]) +
  theme_classic() +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "Diagnosis rank", y = "Diagnosis frequency", color = "")
```
```{r}
bind_rows(
  rank_abundance_plot(df_gpt3.5_icd)$data,
  rank_abundance_plot(df_gpt4.0_icd)$data,
  # rank_abundance_plot(df_gpt4_icd)$data,
  rank_abundance_plot(df_claude3_haiku_t1.0_icd)$data,
  rank_abundance_plot(df_claude3_opus_t1.0_icd)$data,
  rank_abundance_plot(df_gemini1.0_pro_t1.0_icd)$data
  # rank_abundance_plot(df_gemini1.5_flash_t1.0)$data
) %>% 
  ggplot(aes(x = rank, y = freq, color = criteria))+
  # geom_point(size = 0.1)+
  stat_summary(fun.data = mean_se, geom = "ribbon", fill = "grey75", color = "grey75", mapping = aes(group = criteria)) +
  stat_summary(fun.y = mean, geom = "path", size = 1) +
  scale_color_manual(values = brewer.pal(7, "Set1")[-6]) +
  theme_classic() +
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "Diagnosis rank", y = "Diagnosis frequency", color = "")
```

# Top diagnoses
```{r, fig.width = 16, fig.height = 8}
n_diag <- 25
top_diagnosis_plot(df_gpt3.5, n_diag = n_diag)+ggtitle("GPT3")
top_diagnosis_plot(df_gpt4.0, n_diag = n_diag)+ggtitle("GPT4")
top_diagnosis_plot(df_claude3_haiku_t0.1, n_diag = n_diag)+ggtitle("Claude3 Haiku t0.1")
top_diagnosis_plot(df_claude3_haiku_t1.0, n_diag = n_diag)+ggtitle("Claude3 Haiku t1.0")
top_diagnosis_plot(df_claude3_haiku_t1.0, n_diag = n_diag)+ggtitle("Claude3 Opus t1.0")
top_diagnosis_plot(df_gemini1.0_pro_t1.0, n_diag = n_diag)+ggtitle("Gemini t1.0")
top_diagnosis_plot(df_gemini1.5_flash_t1.0, n_diag = n_diag)+ggtitle("Gemini 1.5 Flash")
```

```{r, fig.width = 12, fig.height = 8}
custom_labeler <- function(x, wrap_width=33) {
    x %>%
        str_replace("___.+$", "") %>%
        str_wrap(width = wrap_width)
}

top_diagnosis_plot(df_gpt4_icd, n_diag = 15)+ggtitle("GPT4 ICD") +
      theme(axis.text = element_text(size = 7, lineheight = 0.7), 
          strip.text = element_text(size = 7),
          axis.title = element_text(size = 9)) + 
    tidytext::scale_x_reordered(labels = ~custom_labeler(., wrap_width = 45))
```


```{r, fig.width = 16, fig.height = 8}
calc_freq <- function(df){
  df %>% 
      count(criteria, diagnosis, sort = T) %>% 
      mutate(freq = n/sum(n), .by = criteria) %>% 
      mutate(diagnosis = str_to_sentence(diagnosis))
}

df_all_diags <- tibble(model = c("GPT3", "GPT4", "Claude3_Haiku", "Claude3_Opus", "Gemini t1.0"),
       data = list(df_gpt3, df_gpt4, df_claude3_haiku_t1_0, df_claude3_opus_t1_0, df_gemini_t1_0)) %>% 
  mutate(data = map(data, calc_freq)) %>% 
  unnest(data) 


df_rank_key <- df_all_diags %>% 
  summarise(freq = mean(freq), .by = c("criteria", "diagnosis")) %>% 
  arrange(criteria, desc(freq)) %>% 
  mutate(rank = 1:n(), .by = "criteria") %>% 
  select(-freq)

df_all_diags %>% 
  left_join(df_rank_key, by = c("criteria", "diagnosis")) %>% 
  filter(rank <= n_diag) %>% 
  # slice_max(n=n_diag, order_by = freq, by = criteria) %>% 
    mutate(group = tidytext::reorder_within(diagnosis, freq, within = criteria)) %>% 
    format_criteria() %>% 
    ggplot(aes(x = group, y = freq))+
  # geom_point(size = 0.5)+
  geom_boxplot()+
    # geom_bar(stat = "identity", width = 0.8)+
    tidytext::scale_x_reordered()+
    # tidytext::scale_x_reordered(labels = custom_labeler)+
    theme_bw() +
    coord_flip() +
    labs(x="", y="Frequency") +
    theme(axis.text.x = element_text(angle = 90)) +
    ylim(c(0,0.1))+ # Since 10-item differential, max frequency is 0.1
    facet_wrap(~criteria, scales = "free_y", dir = "v", nrow = 2)
```
```{r, fig.width = 16, fig.height = 10}
custom_labeler <- function(x, wrap_width=33) {
    x %>%
        str_replace("___.+$", "") %>%
        str_wrap(width = wrap_width)
}


calc_freq <- function(df){
  df %>% 
      count(criteria, diagnosis, sort = T) %>% 
      mutate(freq = n/sum(n), .by = criteria) %>% 
      mutate(diagnosis = str_to_sentence(diagnosis))
}

df_all_diags <- tibble(model = c("GPT3", "GPT4", "Claude3_Haiku", "Claude3_Opus", "Gemini1_Pro"),
       data = list(df_gpt3.5_icd, df_gpt4.0_icd, df_claude3_haiku_t1.0_icd, df_claude3_opus_t1.0_icd, df_gemini1.0_pro_t1.0_icd)) %>% 
  mutate(data = map(data, calc_freq)) %>% 
  unnest(data) 


df_rank_key <- df_all_diags %>% 
  summarise(freq = mean(freq), .by = c("criteria", "diagnosis")) %>% 
  arrange(criteria, desc(freq)) %>% 
  mutate(rank = 1:n(), .by = "criteria") %>% 
  select(-freq)

df_all_diags %>% 
  left_join(df_rank_key, by = c("criteria", "diagnosis")) %>% 
  filter(rank <= n_diag) %>% 
  # slice_max(n=n_diag, order_by = freq, by = criteria) %>% 
    mutate(group = tidytext::reorder_within(diagnosis, freq, within = criteria)) %>% 
    format_criteria() %>% 
    ggplot(aes(x = group, y = freq))+
  # geom_point(size = 0.5)+
  # geom_boxplot()+
  # geom_violin()+
  stat_summary(fun.y = mean, geom = "point")+
  stat_summary(fun.min = min, fun.max = max, geom = "errorbar")+
    # geom_bar(stat = "identity", width = 0.8)+
    tidytext::scale_x_reordered()+
    # tidytext::scale_x_reordered(labels = custom_labeler)+
    theme_bw() +
    coord_flip() +
    labs(x="", y="Frequency") +
    theme(axis.text.x = element_text(angle = 90)) +
    ylim(c(0,0.1))+ # Since 10-item differential, max frequency is 0.1
    facet_wrap(~criteria, scales = "free_y", dir = "v", nrow = 2) +
  theme(axis.text = element_text(size = 7, lineheight = 0.7), 
          strip.text = element_text(size = 7),
          axis.title = element_text(size = 9)) + 
    tidytext::scale_x_reordered(labels = ~custom_labeler(., wrap_width = 45))
```


# Cumulative top frequency
```{r, fig.width=3, fig.height=3.5}
cumulative_frequency_plot(df_gpt3.5)+ggtitle("GPT3")
cumulative_frequency_plot(df_gpt4.0)+ggtitle("GPT4")
cumulative_frequency_plot(df_claude3_haiku_t1.0)+ggtitle("Claude3 Haiku")
cumulative_frequency_plot(df_claude3_opus_t1.0)+ggtitle("Claude3 Haiku")
cumulative_frequency_plot(df_gemini1.0_pro_t1.0)+ggtitle("Gemini Pro 1.0")
```
```{r, fig.width=3, fig.height=3.5}
bind_rows(
  cumulative_frequency_plot(df_gpt3.5)$data,
  cumulative_frequency_plot(df_gpt4.0)$data,
  # cumulative_frequency_plot(df_gpt4_icd)$data,
  cumulative_frequency_plot(df_claude3_haiku_t1.0)$data,
  cumulative_frequency_plot(df_claude3_opus_t1.0)$data,
  cumulative_frequency_plot(df_gemini1.0_pro_t1.0)$data,
  # cumulative_frequency_plot(df_gemini1.5_flash_t1.0)$data
) %>% 
  ggplot(aes(x = criteria, y = total_frequency))+
  # geom_boxplot() +
  stat_summary(fun.y = mean, geom = "point", size = 0.75)+
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = sprintf("Combined frequency of top\n%s diagnoses",n_diag), x="")+
  ggpubr::geom_pwc(aes(group = criteria), 
                   method = "wilcox.test",
                   label = "p.signif",
                   p.adjust.method = "BH",
                   hide.ns = T,
                   vjust = 0.5
                   )+
  ylim(c(0,NA))

```

```{r, fig.width=3, fig.height=3.5}
bind_rows(
  cumulative_frequency_plot(df_gpt3.5_icd)$data,
  cumulative_frequency_plot(df_gpt4.0_icd)$data,
  # cumulative_frequency_plot(df_gpt4_icd)$data,
  cumulative_frequency_plot(df_claude3_haiku_t1.0_icd)$data,
  cumulative_frequency_plot(df_claude3_opus_t1.0_icd)$data,
  cumulative_frequency_plot(df_gemini1.0_pro_t1.0_icd)$data,
  # cumulative_frequency_plot(df_gemini1.5_flash_t1.0)$data
) %>% 
  ggplot(aes(x = criteria, y = total_frequency))+
  # geom_boxplot() +
  stat_summary(fun.y = mean, geom = "point", size = 0.75)+
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.5)+
  theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = sprintf("Combined frequency of top\n%s diagnoses",n_diag), x="")+
  ggpubr::geom_pwc(aes(group = criteria), 
                   method = "wilcox.test",
                   label = "p.signif",
                   p.adjust.method = "BH",
                   hide.ns = T,
                   vjust = 0.5
                   )+
  ylim(c(0,NA))

```

# Diagnosis rank list
```{r}
diagnosis_rank_table(df_gpt3.5, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60))
diagnosis_rank_table(df_gpt4.5, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
# diagnosis_rank_table(df_claude3_haiku_t0_1, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_claude3_haiku_t1_0, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_claude3_opus_t1_0, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_gemini_t1_0, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_gemini1.5_flash_t1.0, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
```

```{r}
diagnosis_rank_table(df_gpt3.5_icd, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_gpt4.0_icd, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_claude3_haiku_t1.0_icd, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_claude3_opus_t1.0_icd, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
diagnosis_rank_table(df_gemini1.0_pro_t1.0_icd, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) 
```

```{r}
diagnosis_rank_table(df_gpt4, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) %>% 
  select(contains(c("diagnosis","mcas"))) %>% 
  head(6) %>% 
  mutate(diagnosis = str_to_sentence(diagnosis)) %>% 
  rename(Diagnosis = diagnosis, `MCAS consortium` = mcas_consortium, `MCAS alternative` = mcas_alternative) %>% 
  flextable() %>% 
  width(width = 2) %>% 
  align(j = 2:3, align = "center", part = "all")
  
```




# Diversity

```{r}
calculate_diversity_ci <- function(df, b = 100, seed = 1234){
  require(entropart)
  set.seed(seed)
  
  df %>% 
  count(criteria, diagnosis, sort = T) %>% 
  group_by(criteria) %>% 
  nest() %>% 
  mutate(boot = map(data, function(x){
    x <- deframe(x)
    x <- entropart::EntropyCI(entropart::Shannon, 
                              Simulations=b, 
                              Ns = x, q=1, 
                              Correction = "None")
    x
  })) %>% 
  mutate(shannon = map_dbl(data, 
                           ~log(entropart::Diversity(deframe(.), q=1, Correction="None")))) %>% # Calculate shannon with entropart
  mutate(boot = map(boot, ~quantile(., c(0.025,0.5,0.975)))) %>% 
  unnest_wider(boot)
}

plot_diversity_ci <- function(df){
  plt <- df %>% 
    format_criteria() %>% 
    ggplot(aes(x = criteria, y = shannon))+
    geom_point(size = 1)+
    geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(x = "", y = "Shannon diversity") 
  return(plt)
}
```


```{r, fig.width=4, fig.height=3.5}
calculate_diversity_ci(df_gpt3.5) %>% plot_diversity_ci() + ggtitle("GPT3")
calculate_diversity_ci(df_gpt4.0) %>% plot_diversity_ci() + ggtitle("GPT4")
calculate_diversity_ci(df_claude3_haiku_t1.0) %>% plot_diversity_ci() + ggtitle("Claude3 Haiku")
calculate_diversity_ci(df_claude3_opus_t1.0) %>% plot_diversity_ci() + ggtitle("Claude3 Opus")
calculate_diversity_ci(df_gemini1.0_pro_t1.0) %>% plot_diversity_ci() + ggtitle("Gemini t1.0")

```

```{r, fig.width=4, fig.height=3.5}
calculate_shannon <- function(df){
  table(df$criteria, df$diagnosis) %>% 
    vegan::diversity()
}

tibble(model = c("ChatGPT 3.5", "ChatGPT 4.0", "Claude3 Haiku", "Claude3 Opus", "Gemini 1.0 Pro"),
       data = list(df_gpt3.5, df_gpt4.0, df_claude3_haiku_t1.0, df_claude3_opus_t1.0, df_gemini1.0_pro_t1.0)) %>% 
  mutate(shannon = map(data, calculate_shannon)) %>% 
  select(model, shannon) %>% 
  unnest_wider(shannon) %>% 
  pivot_longer(-model, names_to = "criteria", values_to = "shannon") %>% 
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = shannon, color = model))+
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.3, aes(group = 1))+
  # geom_boxplot(aes(group = criteria))+
  # geom_jitter(size= 0.5)+
  geom_point(size = 1, position = position_dodge(width = 0.75))+
  theme_bw() +
  scale_color_brewer(palette = "Dark2")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggpubr::geom_pwc(aes(group = criteria), 
                   method = "wilcox.test",
                   label = "p.signif",
                   p.adjust.method = "BH",
                   hide.ns = T,
                   vjust = 0.5
                   )+
  labs(x = "", y = "Shannon Diversity", color = "")
                   # remove.bracket = T)
                   # symnum.args = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                   #  symbols = c("****", "***", "**", "*", "ns")))
  # ggpubr::stat_compare_means(comparisons = list(c("SLE - EULAR-ACR", "MCAS - Alternative")))
```

```{r, fig.width=4, fig.height=3.5}
calculate_shannon <- function(df){
  table(df$criteria, df$diagnosis) %>% 
    vegan::diversity()
}

tibble(model = c("ChatGPT 3.5", "ChatGPT 4.0", "Claude3 Haiku", "Claude3 Opus", "Gemini 1.0 Pro"),
       data = list(df_gpt3.5_icd, df_gpt4.0_icd, df_claude3_haiku_t1.0_icd, df_claude3_opus_t1.0_icd, df_gemini1.0_pro_t1.0_icd)) %>% 
  mutate(shannon = map(data, calculate_shannon)) %>% 
  select(model, shannon) %>% 
  unnest_wider(shannon) %>% 
  pivot_longer(-model, names_to = "criteria", values_to = "shannon") %>% 
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = shannon, color = model))+
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.3, aes(group = 1))+
  # geom_boxplot(aes(group = criteria))+
  # geom_jitter(size= 0.5)+
  geom_point(size = 1, position = position_dodge(width = 0.75))+
  theme_bw() +
  scale_color_brewer(palette = "Dark2")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggpubr::geom_pwc(aes(group = criteria), 
                   method = "wilcox.test",
                   label = "p.signif",
                   p.adjust.method = "BH",
                   hide.ns = T,
                   vjust = 0.5
                   )+
  labs(x = "", y = "Shannon Diversity", color = "")
                   # remove.bracket = T)
                   # symnum.args = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1), 
                   #  symbols = c("****", "***", "**", "*", "ns")))
  # ggpubr::stat_compare_means(comparisons = list(c("SLE - EULAR-ACR", "MCAS - Alternative")))
```


```{r}
x <- tibble(model = c("GPT3", "GPT4", "GPT4_ICD", "Claude3_Haiku", "Gemini t1.0"),
       data = list(df_gpt3, df_gpt4, df_gpt4_icd, df_claude3_haiku, df_gemini_t1_0)) %>% 
  mutate(shannon = map(data, calculate_shannon)) %>% 
  select(model, shannon) %>% 
  unnest_wider(shannon) %>% 
  pivot_longer(-model, names_to = "criteria", values_to = "shannon") %>% 
  format_criteria()

pairwise.wilcox.test(x = x$shannon, g = as.character(x$criteria), p.adjust = "BH", paired = F) %>% 
  broom::tidy() %>% 
  arrange(p.value)
```



### Permutation testing

```{r, eval = F}
# Run outside of notebook
# Includes all 10,000 GPT iterations and 1000 bootstrap permutations 
# Contained in script source(here("scripts/diversity_analysis/permute_null_diversity_difference.R"))
library(here)
source(here("utils/data_processing.R"))
library(tidyverse)
library(vegan)
library(broom)
library(here)
library(furrr)
library(future.apply)

model <- "gpt4"
p <- 1000
i <- 10000

print("### Reading data")
read_path <- sprintf("data/processed_diagnoses/diagnoses_%s.csv.gz", model)
df <- read_csv(here(read_path))

print("### Calculating permutation")
perm_out <- difference_permutation_test(df, metric = "precision", permutations = p, gpt_iterations = i)

print("### Writing data")
write_path <- sprintf("data/diversity_analysis/precision_permutation_test_%s_p%s_i%s.RDS", model, p, i)
saveRDS(perm_out, here(write_path))
```

```{r}
diversity_permutation_results <- readRDS(here("data/diversity_analysis/diversity_permutation_test_gpt4.RDS")) 
diversity_permutation_results
```
```{r}
permutation_test_plot(diversity_permutation_results)
```


# Similarity

### Jaccard/Bray curtis
```{r, fig.width=4.25, fig.height=3.5}
diagnosis_similarity_heatmap(df_gpt3, method = "bray")
diagnosis_similarity_heatmap(df_gpt4, method = "bray")
diagnosis_similarity_heatmap(df_gpt3)
diagnosis_similarity_heatmap(df_gpt4)
```
- Bray-Curtis similarity measures the similarity of a given diagnostic criteriaâ€™s set of alternative diagnoses along with their frequencies.
- This demonstrates that SLE criteria results in a very similar set and frequency of diagnoses, while the diagnoses associated with two MCAS criteria are as different from each other as they are from those generated by the criteria of other conditions.

### PCA

```{r, fig.width=4.25, fig.height=3.5}
diagnosis_pca_plot(df_gpt3) + ggtitle("GPT3")
diagnosis_pca_plot(df_gpt4) + ggtitle("GPT4")
```
# Precision

- Precision represents how similar each iteration of a 10-point differential diagnosis is with all other differential diagnoses from the same set of criteria. 
- I.e. how reproducible the 10-point differential diagnosis is for each criteria
- Measured by obtaining the Bray-Curtis similarity values between all iterations within a criteria

```{r, eval=F}
# Script for calculating all Bray-Curtis similarity values within a criteria
# Found in source(here("scripts/diversity_analysis/calculate_precision.R"))
library(here)
source(here("utils/data_processing.R"))

models <- c("gpt3", "gpt4", "gpt4_icd")

for (m in models){
  print(sprintf("READING IN DATA FOR: %s", m))
  read_path <- sprintf("data/processed_diagnoses/diagnoses_%s.csv.gz", m)
  df <- read_csv(here(read_path))
  
  print(sprintf("CALCULATING PRECISION FOR: %s", m))
  df <- calculate_precision(df)
  
  print(sprintf("WRITING PRECISION DATA FOR: %s", m))
  out_path <- sprintf("data/diversity_analysis/diagnosis_precision_%s.csv.gz", m)
  write_csv(df, here(out_path))
}
```

```{r}
df_precision <- vroom::vroom(here("data/diversity_analysis/diagnosis_precision_gpt4.csv.gz"))
```

```{r}
df_precision_summary <- df_precision %>% 
  mutate(distance = 1-distance) %>% # Convert to similarity
  summarise(mean_cl_normal(distance), .by = criteria)
df_precision_summary
```

```{r, fig.width = 3, fig.height = 3}
calculate_boxplot_stats <- function(df){
  df %>% 
    nest(data = distance, .by = criteria) %>% 
    mutate(box = map(data, function(df){
      x <- boxplot.stats(df$distance)$stats
      x <- sort(x)
      names(x) <- c("min","lower","median","upper","max")
      return(x)
    })) %>% 
    select(-data) %>% 
    unnest_wider(box)
}



manual_box_plot <- function(df, width = 0.9){
  df %>% 
    format_criteria() %>% 
    ggplot(aes(
      x = criteria,
      ymin = min,
      lower = lower,
      middle = median,
      upper = upper,
      ymax = max
    ))+
    geom_boxplot(stat = "identity", width = width) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    labs(x = "", y = "Bray-Curtis similarity")
}

```


```{r}
df_precision_stats <- df_precision %>% 
  mutate(distance = 1-distance) %>% # Convert to similarity
  calculate_boxplot_stats()
df_precision_stats
```
```{r, fig.width=3, fig.height=3}
manual_box_plot(df_precision_stats)
```
### Permutation testing

```{r, eval = F}
# Run outside of notebook
# Tried multiple combinations of bootstrap permutations and gpt_iterations
# Because a single bray-curtis matrix of all 10,000 comparisons takes ~10 minutes
# Contained in following script:
# source(here("scripts/diversity_analysis/permute_null_precision_difference.R"))
model <- "gpt4"
p <- 1000
i <- 10000

print("### Reading data")
read_path <- sprintf("data/processed_diagnoses/diagnoses_%s.csv.gz", model)
df <- read_csv(here(read_path))

print("### Calculating permutation")
perm_out <- difference_permutation_test(df, metric = "precision", permutations = p, gpt_iterations = i)

print("### Writing data")
write_path <- sprintf("data/diversity_analysis/precision_permutation_test_%s_p%s_i%s.RDS", model, p, i)
saveRDS(perm_out, here())
```


```{r}
readRDS(here("data/diversity_analysis/precision_permutation_test_gpt4_p1000_i10000.RDS"))
```


```{r}
readRDS(here("data/diversity_analysis/precision_permutation_test_gpt4_p1000_i10000.RDS")) %>% permutation_test_plot()
```


# iNEXT

```{r, fig.width=12, fig.height=4}
inext_plots <- function(inext_obj){
  for (i in 1:3){
    plt <- iNEXT::ggiNEXT(inext_obj, type=i, facet.var="Assemblage", color.var="Assemblage") +
      theme_classic() + 
      scale_color_brewer(palette = "Set1") +
      theme(axis.text.x = element_text(angle = 90))+
      scale_color_brewer(palette = "Dark2")
    print(plt)
  }
}

readRDS(here("data/diversity_analysis/mcas_iNEXT_gpt4_e250000.RDS")) %>% inext_plots()
readRDS(here("data/diversity_analysis/mcas_iNEXT_dropSingle_gpt4_e200000.RDS")) %>% inext_plots()
readRDS(here("data/diversity_analysis/mcas_iNEXT_dropSingle_psuedoMinus_gpt4_e200000.RDS")) %>% inext_plots()
```


# Final figures

### 2_Top_diagnoses
```{r, fig.width=7.4, fig.height=6.5}
custom_labeler <- function(x, wrap_width=33) {
    x %>%
        str_replace("___.+$", "") %>%
        str_wrap(width = wrap_width)
}

plt_top <- top_diagnosis_plot(df_gpt4, n_diag = 25) + 
  theme(axis.text = element_text(size = 5, lineheight = 0.7), 
        strip.text = element_text(size = 7),
        axis.title = element_text(size = 9)) + 
  tidytext::scale_x_reordered(labels = custom_labeler)
plt_top
```

```{r}
ggsave(plot=plt_top,filename=here("figures/3_Top_25_diagnoses.pdf"), width = 7.4, height = 6.5)
```


### 3A_Rank_abundance
```{r, fig.width=3.5, fig.height=2.5}
plt_rank <- rank_abundance_plot(df_gpt4) +theme(legend.position = c(0.7,0.7))
plt_rank
```

### 3B_Cumulative_frequency

```{r, fig.width=2.5, fig.height=2.5}
plt_cumulative <- cumulative_frequency_plot(df_gpt4) +
  labs(y = "Combined frequency\nof top 25 diagnoses")
plt_cumulative
```



### 3C_Diversity
```{r, fig.width=3, fig.height=3}
plt_div <- df_diversity_ci %>% 
  format_criteria() %>% 
  ggplot(aes(x = criteria, y = shannon))+
  geom_point(size = 1)+
  geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "", y = "Shannon diversity") 
plt_div
```
### 3D_Precision
```{r, fig.width=3, fig.height=3}
plt_precision <- manual_box_plot(df_precision_stats)
plt_precision
```
### 3_Compiled 

```{r, fig.width=6.5, fig.height=6}
plt_fig3 <- plot_grid(
  plot_grid(NULL),
  plot_grid(
    plt_rank,
    NULL,
    plt_cumulative,
    nrow = 1, 
    rel_widths = c(3,0.2,2),
    labels = c("A", "", "B"),
    vjust = 0.2
  ),
  plot_grid(NULL),
  plot_grid(
    plt_div,
    NULL,
    plt_precision,
    nrow = 1,
    rel_widths = c(1,0.1,1),
    labels = c("C", "", "D"),
    vjust = 0.2
  ),
  ncol = 1,
  rel_heights = c(0.05,1,0.05,1)
)
plt_fig3
ggsave(plot=plt_fig3,filename=here("figures/4_Diagnosis_diversity.pdf"), width = 6.5, height = 6)
```

### Table

```{r, message = F, warning=FALSE}
diagnosis_rank_table(df_gpt4, "mast |mastoc|anaphylaxis") %>% mutate(diagnosis = substr(diagnosis, 1, 60)) %>% 
  select(contains(c("diagnosis","mcas"))) %>% 
  head(6) %>% 
  mutate(diagnosis = str_to_sentence(diagnosis)) %>% 
  rename(Diagnosis = diagnosis, `MCAS consortium` = mcas_consortium, `MCAS alternative` = mcas_alternative) %>% 
  flextable() %>% 
  width(width = 2) %>% 
  align(j = 2:3, align = "center", part = "all") %>% 
  {print(., preview = "pdf");.}
```

### Supplemental figures

```{r, fig.width=7, fig.height=10, message = F}
plot_grid(
  top_diagnosis_plot(df_gpt3, n_diag = 25) + 
    theme(axis.text = element_text(size = 4.5, lineheight = 0.7), 
          strip.text = element_text(size = 7),
          axis.title = element_text(size = 9)) + 
    tidytext::scale_x_reordered(labels = custom_labeler),
  
  top_diagnosis_plot(df_gpt4_icd, n_diag = 25) + 
    theme(axis.text = element_text(size = 4, lineheight = 0.7), 
          strip.text = element_text(size = 7),
          axis.title = element_text(size = 9)) + 
    tidytext::scale_x_reordered(labels = ~custom_labeler(., wrap_width = 45)),
  ncol = 1,
  rel_heights = c(0.9,1),
  labels = c("A","B")
) %>% 
  {ggsave(plot=.,filename=here("figures/S_Top_diagnoses.pdf"), width = 7, height = 10);.}
```
```{r, fig.width=7.5, fig.height=3}
plot_grid(
  rank_abundance_plot(df_gpt3) +theme(legend.position = c(0.7,0.7)),
  rank_abundance_plot(df_gpt4_icd) +theme(legend.position = c(0.7,0.7)),
  nrow = 1,
  labels = c("A","B")
) %>% 
  {ggsave(plot=.,filename=here("figures/S_Ranked_abundance.pdf"), width = 7.5, height = 3);.}
```
### Alternative combined figure
```{r, fig.width=7, fig.height=9, message = F}
n_diagnoses_bar <- 15
n_diagnoses_abundance <- 50
n_diagnoses_cumulative <- 50

apply_text_formatting <- list(theme(
  axis.text = element_text(size = 6),
  axis.title = element_text(size = 9),
  legend.text = element_text(size = 6),
  # legend.spacing.y = unit(0.1, 'cm')
  # legend.height = unit(0.1, 'cm'),
  legend.key.height = unit(0.3, 'cm')
  # legend.key.spacing = unit(0.1, 'cm')
  ))
  
  
plot_grid(
  
  ###
  top_diagnosis_plot(df_gpt4, n_diag = n_diagnoses_bar) + 
    theme(axis.text = element_text(size = 5, lineheight = 0.7), 
          strip.text = element_text(size = 7),
          axis.title = element_text(size = 9)) + 
    tidytext::scale_x_reordered(labels = custom_labeler),
  ###
  NULL,
  plot_grid(
    plot_grid(NULL),
    plot_grid(
      NULL,
      ####
      rank_abundance_plot(df_gpt4, n_diagnoses = n_diagnoses_abundance) +theme(legend.position = c(0.7,0.7)) + apply_text_formatting,
      ###
      NULL,
      ###
      cumulative_frequency_plot(df_gpt4, n_diagnoses = n_diagnoses_cumulative) + labs(y = str_glue("Combined frequency\nof top {n_diagnoses_cumulative} diagnoses")) + apply_text_formatting,
      ###
      NULL,
      nrow = 1, 
      rel_widths = c(0.2, 2.5, 0.2, 2, 0.2 ),
      # labels = c("A", "", "B"),
      vjust = 0.2
    ),
    plot_grid(NULL),
    plot_grid(
      NULL,
      ###
       df_diversity_ci %>% 
        format_criteria() %>% 
        ggplot(aes(x = criteria, y = shannon))+
        geom_point(size = 1)+
        geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
        theme_bw() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(x = "", y = "Shannon\ndiversity") + apply_text_formatting,
      ###
      NULL,
      ###
      manual_box_plot(df_precision_stats) + labs(y='Bray-Curtis\nsimilarity') + apply_text_formatting,
      ###
      NULL,
      nrow = 1,
      rel_widths = c(0.2, 1, 0.1, 1, 0.2),
      # labels = c("C", "", "D"),
      vjust = 0.2
    ),
    ncol = 1,
    rel_heights = c(0.05,1,0.05,1)
  ),
  
  ncol = 1,
  rel_heights = c(0.9,0.02,1)
) %>% 
  {ggsave(plot=.,filename=here("figures/3_4_combined.pdf"), width = 7, height = 9);.}



```

```{r, fig.width=7, fig.height=7, message = F}
n_diagnoses_bar <- 15
n_diagnoses_abundance <- 50
n_diagnoses_cumulative <- 50

apply_text_formatting <- list(theme(
  axis.text = element_text(size = 6),
  axis.title = element_text(size = 9),
  legend.text = element_text(size = 6),
  # legend.spacing.y = unit(0.1, 'cm')
  # legend.height = unit(0.1, 'cm'),
  legend.key.height = unit(0.3, 'cm')
  # legend.key.spacing = unit(0.1, 'cm')
  ))
  
  
plot_grid(
  
  ###
  top_diagnosis_plot(df_gpt4, n_diag = n_diagnoses_bar) + 
    theme(axis.text = element_text(size = 5, lineheight = 0.7), 
          strip.text = element_text(size = 7),
          axis.title = element_text(size = 9)) + 
    tidytext::scale_x_reordered(labels = custom_labeler),
  ###
  NULL,
  plot_grid(
      rank_abundance_plot(df_gpt4, n_diagnoses = n_diagnoses_abundance) +theme(legend.position = c(0.7,0.7)) + apply_text_formatting,
      cumulative_frequency_plot(df_gpt4, n_diagnoses = n_diagnoses_cumulative, width = 0.75) + labs(y = str_glue("Combined frequency\nof top {n_diagnoses_cumulative} diagnoses")) + apply_text_formatting,
      df_diversity_ci %>% 
        format_criteria() %>% 
        ggplot(aes(x = criteria, y = shannon))+
        geom_point(size = 1)+
        geom_errorbar(aes(ymin = `2.5%`, ymax = `97.5%`), width = 0.3)+
        theme_bw() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        labs(x = "", y = "Shannon diversity") + apply_text_formatting,
      manual_box_plot(df_precision_stats, width = 0.5) + labs(y='Bray-Curtis similarity') + apply_text_formatting,
      nrow = 1, 
      axis = 'tb',
      align = 'h',
      rel_widths = c(1, 0.7, 0.7, 0.7),
      labels = c(LETTERS[2:5]),
      vjust = 0.2
    ),
  ncol = 1,
  rel_heights = c(1, 0.05, 0.65),
  labels = c("A","","")
)  %>% 
  {ggsave(plot=.,filename=here("figures/3_diagnosis_diversity.pdf"), width = 7, height = 7);.}



```

